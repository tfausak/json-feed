sudo: false
language: generic
addons:
  apt:
    packages:
      - libgmp-dev
cache:
  directories:
    - $HOME/.local/bin
    - $HOME/.stack
env:
  global:
    - HACKAGE_USERNAME=fozworth
    - secure: tda6hl77RB3l8WZQtPGcT0v0r4ChlfFLqjLqzrJOUHsWawQwgauWckvZh9mkIK4ye610FZkrB5S8asEMtN7Ql6SK2FuXq/4t59VMQTjEiu/OKNJjhgcuEXRdkmA/hljVOvh2NiTqXgf1ap0J3rcle7R7I3c2F9XLZQHArX2R9qaEDjyXG6dcFy6c93q5Vi6xmHhVXX0sRKVyrDCR5NANdT1XDOXc3Bis8q//uXeJ/jnMztGddnZUh5+R/FTnd7hA9vCQFRy5mS0zbjSiBCg+UtKlxJ9KqN2Pqilheq5hqIuW5JOjxVciviPRdXN9dOLMcANZZtb64QVcPhcK5Qm8N97MSiYqspGZ3ql5O1SUJ5ZzQjjcZPVbYtaSAf35HvoFKdCGe5hRxDZi1NkgQKkwr86qoLdALRoz+Dv7ZMpEudnUGtZze0O56T/e5XV7WMNMU7EA4RQkQHYADIT5n8iVeiAn8PBtg0fEmsObrhlH2I7cVLVVCfuWQIUEbhEqAhY9XToUJhbEXB3NylTDxYXT8W5NhmkjiFLBYoM8su/gLW/PN5vLGcctXW/jIIBJfmny2+3Q1JoT2iEj3HQmRMYSryRByGG4Ef36pKUBQ3g1bvmo7vo3INeIPsqxhFtPht0Gre6EqtT7SEIoVOxFxpTLV6imxrsmhRdEAqJy6wVpavE=
before_install:
  - |
    if test ! -f "$HOME/.local/bin/stack"
    then
      VERSION=1.9.1
      URL="https://github.com/commercialhaskell/stack/releases/download/v$VERSION/stack-$VERSION-$TRAVIS_OS_NAME-x86_64.tar.gz"
      cd /tmp
      curl --location "$URL" > stack.tar.gz
      gunzip stack.tar.gz
      tar --extract --file stack.tar --strip-components 1
      mkdir --parents "$HOME/.local/bin"
      mv stack "$HOME/.local/bin"
      cd -
    fi
  - stack --version
install:
  - stack setup
  - stack build --only-dependencies --test
script:
  - stack build --pedantic --test
  - stack sdist
after_success:
  - mkdir -p deploy
  - cp -v "$(stack path --dist-dir)/json-feed-$TRAVIS_TAG.tar.gz" deploy/json-feed.tgz
  - mkdir -p "$HOME/.stack/upload"
  - >-
    echo "{
    \"username\": \"$HACKAGE_USERNAME\",
    \"password\": \"$HACKAGE_PASSWORD\"
    }" > "$HOME/.stack/upload/credentials.json"
deploy:
  - skip_cleanup: true
    on: { tags: true }
    provider: releases
    api_key: { secure: TIlurnIJ7/sjTXd0P7YbcQvPgjtRmOQhqnNAiglYptucJf13Vdo61uLztHHI6C6u9tXgiC2kH8S1YW16zu3GYCOae1OUAvUbMQRyHjMR0+FhjS/LYaGa5EhfX53KVzl2hhMRzsdCGT+KrN3diBZnLuC6vb0Q2vIsvfpuBrX+4He6cr46McoxeZEA6SeSoy0QkFoaD7qMbNs6pgl9YEfV/yMdfMcH1MI+S0fjL++OE2H6VNlrzPiM3md+hMZiVRabqmRTnyLrtt6JMYfvRzlEJQCTGhXxm8ElxEVDpVQMT2PxYn210z0E7jvvqKQTsT1Usa6d0YHUzS3ZfRc2MMFtHktClclAXz/QUS5+0ajQO/5L9Ofku2AWhwRkFOCa4qb6xk0pNuXqKkyuvC+36SA863dYn0nSL+iU9KxRape+ZXqNt9EvH3qZtI/OxvMNPe4BQdxWlaaVu3pTdbC4pdfXCbDF8+7bPJ2DoQ1I7g9dtdv0onOnqI9DV5EThvhUbV+o3cae5dWzQqKcmske6p08Jj1zGdIgyE2beKuYyz+P8o3+KUgvd/jvVH8g0/eIzP6MhIzuLjqr85Jj7+ilJ7C5PIUnCbdfY96nWtEnNXcCWOExBpXBzURzenslMw1jToMEqxxtDooCMcgboEOrF2XCwxd68OnJqQofvgg7BgplA5k= }
    file: deploy/json-feed.tgz
  - skip_cleanup: true
    on: { tags: true }
    provider: script
    script: stack upload .
